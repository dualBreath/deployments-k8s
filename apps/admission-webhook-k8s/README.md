# Webhook options

## Prerequisite

This is only possible for local setup:
- clone project
- use [`to-local.sh`](../../to-local.sh)
- then run all the commands in the `deployments-k8s` folder

Usual way to apply example:
1. set up spire
2. set up basic example
3. set up example

In order for the changes below to work, they must be made before step 2.

As the first step for all cases below delete the spiffeid Spire webhook template if it exists:
```bash
  $ kubectl delete clusterspiffeid.spire.spiffe.io/nsm-workloads-webhook
```
or skip it's installation step if you haven't configured Spire yet

## Use existing certificates

If you want to use the existing certificates, you need to complete the following steps:

- remove Spire spiffeid label from `mutating-webhook-config.yaml`:
```yaml
  labels:
    spiffe.io/webhook: "true"
```

- add `caBundle` value with existing certificate to `mutating-webhook-config.yaml`:
```yaml
clientConfig:
    caBundle: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS...
```

- add env variables to `admission-webhook.yaml`:
```yaml
- name: NSM_WEBHOOK_MODE
  value: secret
- name: NSM_SECRET_NAME
  value: secret-tls
```
**Note** `NSM_SECRET_NAME` value should be the same as `name` in the `webhook-secret-example.yaml`

- put the existing certificate and key in `webhook-secret-example.yaml`:
```yaml
data:
  tls.crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0F...
  tls.key: LS0tLS1CRUdJTiBQUklWQVRFIEt...
```

- add `webhook-secret-example.yaml` at the beginning of `resources` list in `kustomization.yaml`

**Note** The following labels are not needed in this case and can be removed from `admission-webhook.yaml` if necessary:

```yaml
labels:
  dns-name: admission-webhook-svc
  spiffe.io/spiffe-id-webhook: "true"
```

## Autogenerated webhook

As a first step in both cases, remove `mutating-webhook-config.yaml` from the `kustomization.yaml` resources because it will be generated automatically.

**Note** The following labels are not needed in this case and can be removed from `admission-webhook.yaml` if necessary:

```yaml
labels:
  dns-name: admission-webhook-svc
  spiffe.io/spiffe-id-webhook: "true"
```

### Automatically generated configuration and certificate for the admission webhook

- add env variable to `admission-webhook.yaml`:
```yaml
- name: NSM_WEBHOOK_MODE
  value: selfregister
```

### Automatically generated configuration with existing certificate for the admission webhook

- add env variables to `admission-webhook.yaml`:
```yaml
- name: NSM_WEBHOOK_MODE
  value: selfregister
- name: NSM_CERT_FILE_PATH
  value: /etc/cert/tls.crt
- name: NSM_KEY_FILE_PATH
  value: /etc/cert/tls.key
- name: NSM_CA_BUNDLE_FILE_PATH
  value: /etc/cert/caBundle.crt
```

- add volume with certificates to `admission-webhook.yaml`:
```yaml
  volumeMounts:
    - name: cert
      mountPath: "/etc/cert"
      readOnly: true
    ...
  volumes:
  - name: cert
    secret:
      secretName: secret-tls
  ...
```

- put the existing certificate, key and CA bundle in `webhook-secret-example.yaml`:
```yaml
data:
  tls.crt: LS0tLS1CRUdJTiBDRVJUSUZJQ0F...
  tls.key: LS0tLS1CRUdJTiBQUklWQVRFIEt...
  caBundle.crt: LS0tLS1CRUdJTiBDRVJUSU...
```

- add `webhook-secret-example.yaml` at the beginning of `resources` list in `kustomization.yaml`

## Generate certificates

For testing purposes the openssl tool can be used with the following script:
```bash
$ CONFIG="$(openssl version -d | sed -E 's/OPENSSLDIR: "(.*)"/\1/g')/openssl.cnf"
$ openssl req -x509 -nodes -days 365 -subj '/C=US/O=Community/CN=NSM root CA' -newkey rsa:2048 -keyout caBundle.key -out caBundle.crt
$ openssl req -nodes -new -subj '/C=US/O=Community/CN=NSM' -newkey rsa:2048 -keyout tls.key -out tls.csr
$ openssl x509 -req -days 365 -sha256 -extensions SAN -extfile <(cat "${CONFIG}"; echo '[SAN]'; echo 'subjectAltName=DNS:admission-webhook-svc.nsm-system,DNS:admission-webhook-svc.nsm-system.svc') -CA caBundle.crt -CAkey caBundle.key -CAcreateserial -in tls.csr -out tls.crt
```
To use the generated certificates, first convert them to base64 format:
```bash
$ cat ./tls.key | base64
$ cat ./tls.key | base64
$ cat ./caBundle.crt | base64
```
