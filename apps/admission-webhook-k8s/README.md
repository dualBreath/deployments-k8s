# Webhook options

## Prerequisite

This is only possible for local setup:
- clone project
- use [`to-local.sh`](../../to-local.sh)
- then run all the commands in the `deployments-k8s` folder

Usual way to apply example:
1. set up spire
2. set up basic example
3. set up example

In order for the changes below to work, they must be made before step 2.

As the first step for all cases below delete the spiffeid Spire webhook template if it exists:
```bash
kubectl delete clusterspiffeid.spire.spiffe.io/nsm-workloads-webhook
```
or skip it's installation step if you haven't configured Spire yet

**Note** The following labels are only used for certificates signed by Spire and can be removed from `admission-webhook.yaml`:

```yaml
labels:
  dns-name: admission-webhook-svc
  spiffe.io/spiffe-id-webhook: "true"
```

## Use existing certificates

If you want to use the existing certificates, you need to complete the following steps:

- remove Spire spiffeid label from `mutating-webhook-config.yaml`:
```yaml
  labels:
    spiffe.io/webhook: "true"
```

- create [nsm-namespace](../../examples/basic/nsm-system-namespace.yaml)
```bash
kubectl apply -f ../../examples/basic/nsm-system-namespace.yaml
```

- create a secret with your certificate:
```bash
kubectl create secret tls webhook-cert -n nsm-system --key="tls.key" --cert="tls.crt"
```

- convert `ca.crt` to base64 format:
```bash
cat ./ca.crt | base64
```

- add `caBundle` value with existing `ca.crt` certificate (in base64 format) to `mutating-webhook-config.yaml`:
```yaml
clientConfig:
    caBundle: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS...
```

- add env variables to `admission-webhook.yaml`:
```yaml
- name: NSM_CERT_FILE_PATH
  value: /etc/cert/tls.crt
- name: NSM_KEY_FILE_PATH
  value: /etc/cert/tls.key
```

- add volume with certificates to `admission-webhook.yaml`:
```yaml
  volumeMounts:
    - name: cert
      mountPath: "/etc/cert"
      readOnly: true
    ...
  volumes:
  - name: cert
    secret:
      secretName: webhook-cert
  ...
```

## Autogenerated webhook

As a first step in both cases, remove `mutating-webhook-config.yaml` from the `kustomization.yaml` resources because it will be generated automatically.

### Automatically generated configuration and certificate for the admission webhook

- add env variable to `admission-webhook.yaml`:
```yaml
- name: NSM_WEBHOOK_MODE
  value: "selfregister"
```

### Automatically generated configuration with existing certificate for the admission webhook

- create [nsm-namespace](../../examples/basic/nsm-system-namespace.yaml)
```bash
kubectl apply -f ../../examples/basic/nsm-system-namespace.yaml
```

- create a secret with your certificate:
```bash
kubectl create secret generic webhook-cert -n nsm-system --from-file=tls.key="tls.key" --from-file=tls.crt="tls.crt" --from-file=ca.crt="ca.crt" --type="kubernetes.io/tls"
```

- add env variables to `admission-webhook.yaml`:
```yaml
- name: NSM_WEBHOOK_MODE
  value: "selfregister"
- name: NSM_CERT_FILE_PATH
  value: /etc/cert/tls.crt
- name: NSM_KEY_FILE_PATH
  value: /etc/cert/tls.key
- name: NSM_CA_BUNDLE_FILE_PATH
  value: /etc/cert/ca.crt
```

- add volume with certificates to `admission-webhook.yaml`:
```yaml
  volumeMounts:
    - name: cert
      mountPath: "/etc/cert"
      readOnly: true
    ...
  volumes:
  - name: cert
    secret:
      secretName: webhook-cert
  ...
```

## Generate certificates

For testing purposes the openssl tool can be used with the following commands:
```bash
CONFIG="$(openssl version -d | sed -E 's/OPENSSLDIR: "(.*)"/\1/g')/openssl.cnf"
openssl req -x509 -nodes -days 365 -subj '/C=US/O=Community/CN=NSM root CA' -newkey rsa:2048 -keyout ca.key -out ca.crt
openssl req -nodes -new -subj '/C=US/O=Community/CN=NSM' -newkey rsa:2048 -keyout tls.key -out tls.csr
openssl x509 -req -days 365 -sha256 -extensions SAN -extfile <(cat "${CONFIG}"; echo '[SAN]'; echo 'subjectAltName=DNS:admission-webhook-svc.nsm-system,DNS:admission-webhook-svc.nsm-system.svc') -CA ca.crt -CAkey ca.key -CAcreateserial -in tls.csr -out tls.crt
```
